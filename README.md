# Умное реле освещения с датчиком присутствия и освещенности
**Уличный датчик присутствия ESPHome с интеграцией в HomeAssistant**

Основная проблема в том, что датчики движения не имеют высокой чувствительности, в отличие от датчиков присутствия, что в результате приводит к выключению реле (а в моем случае и уличного освещения) когда человек, который находится в зоне действия сенсора, почти не двигается. Можно, конечно, увеличить таймаут выключения, надеясь на то, что за это время произойдет движение, достаточное для сброса встроенного таймера, но зачастую этого не происходит. В том числе это увеличивает время работы освещения когда человек покинул зону действия датчика. Дополнительно - он реагирует на все, что движется: паук, муха, оса, деревья, снег, сильный дождь... Поэтому такие датчики (хоть они и названы "уличными" имея влагозащищенный корпус) больше предназначены для помещений - типа подъезд, кладовая, гараж и т.п. Мелочи, но лично меня все это беспокоит.

![2025-10-21 00 04 43](https://github.com/user-attachments/assets/75b15cd3-560e-4f1e-807f-2850bd0a9995)

При проектировании данного реле я поставил перед собой задачу иметь возможность использовать его не только в качестве умного самостоятельного устройства (в частности управляемого), но и как самостоятельное устройство без возможности интеграции в умный дом. Поэтому я спроектировал плату соответствующим образом. 

<img width="1065" height="636" alt="image" src="https://github.com/user-attachments/assets/ca943847-7384-467d-9628-ff085f6bf26e" />

В качестве контроллера взята за основу плата ESP32c3 Suрer Mini, в качестве сенсора присутствия могут использоваться два варианта датчиков присутствия - HLK LD2410B ("B" с блютус) и HLK LD2402 или 2420. Об их настройке есть много информации в сети Интернет. Но основной параметр - это их чувствительность, которая ограничивается расстоянием обнаружения присутствия - она составляет (как заявлено производителем, так и фактически проверено мною) - до 7 метров. Для мох задач (освещение небольшой поляны у дома) вполне хватает. А для того, чтобы освещение включать только в ночное время я использовал датчик освещенности GY-2561/TSL2561. 

Проект платы: 
<img width="958" height="857" alt="image" src="https://github.com/user-attachments/assets/cd44ddcc-0bf9-4474-8d49-15945121a6f3" />

<img width="931" height="790" alt="image" src="https://github.com/user-attachments/assets/63ca2cf7-0bdd-404b-a48e-2f7f985961f3" />

В случае если необходимо использовать устройство только на включение/выключение нагрузки без контроля уровня освещенности и управления - можно не устанавливать контроллер ESP32 c3 Super Mini и датчик освещенности GY-2561/TSL2561. Для этого используется выход состояния присутствия OT2, предусмотренный производителем датчика HLK-LD2410B или HLK-LD2402/HLK-LD2420. 

В случае использования датчика HLK-LD2402/HLK-LD2420 необходимо будет припаять стаблизатор напряжения DC1 HT7333-3.3 с обвязкой из конденсаторов, который располагается на плате под самим датчиком, когда как для использования HLK-LD2410B данная цепь питания не требуется. 

<img width="470" height="243" alt="image" src="https://github.com/user-attachments/assets/b7b12d2e-7781-45eb-a1b7-2ea09469d75f" />

Для изменения режимов работы датчика (умный/не умный) на плате предусмотрена перемычка "ESP/OI2". ОТ2 - это контакт состояния присутствия на датчиках присутствия, т.е. управляющий контакт с датчика напрямую подключается к цепи управления реле. Реле, кстати, использовано на нагрузку 10А (с запасом мощности), что вполне достаточно для управления небольшой группой освещения. 
Статусный светодиод мигает сразу после обнаружения движения с последующим включением освещения.

Gerber и BOM файл:
[Gerber_PCB1_2025-09-09.zip](https://github.com/user-attachments/files/22231243/Gerber_PCB1_2025-09-09.zip)
[BOM_Board1_PCB1_2025-09-09.xlsx](https://github.com/user-attachments/files/22231246/BOM_Board1_PCB1_2025-09-09.xlsx)

Прошивка ESP32: [presence-relay-v1-0.factory.bin](https://github.com/diemon24/Presence-relay/blob/main/presence-relay-v1-0.factory.bin)

**Монтаж и коммутация:**

Монтаж реле осуществляется на стену или потолок. Коммутация реле по трехпроводной схеме в разрыв фазы нагрузки: 

<img width="338" height="177" alt="image" src="https://github.com/user-attachments/assets/7370210c-d0b6-4548-8329-92177eee30c6" /> <img width="169" height="117" alt="image" src="https://github.com/user-attachments/assets/477f79f8-fc74-4d13-a81e-61fd2d663999" />

L_IN - фаза вход
N - ноль 
LOAD - фаза выход на нагрузку 

Для корректнной работы реле место монтажа должно быть выбрано с учетом следующих условий:
1. Перед реле не должны быть размещены мебель, стены и иные предметы, которые могут препятствовать прямому прохождению микроволн по всей зоне действия сенсора присутствия; 
2. Место монтажа реле должно предотвращать прямое попадание воды, грязи и т.п. на реле;
3. Не рекомендуется размещение в углах на стенах помещений, в данном случае лучше использовать размещение в углу на потолке под углом 45 градусов (или 1/2 угла) с направлением сенсора присутствия в противоположный дальний нижний угол помещения (пример помещения 5х5м с высотой потолка 2.8м);
4. В длинных и узких помещениях (коридорах и т.п.) рекомендуется размещение реле по центру стены или потолка по короткой стороне с направлением сенсора приутствия вниз в пол на расстояние до 5м от реле. 

****Характеристики: **

Принцип действия - непрерывные микроволны с частотной модуляцией для обнаружения человеческих целей в заданном пространстве
Виды режимов работы реле - по уровню освещенности
Задержка времени выключения - настраиваемая
Порог срабатывания - настраиваемый от 0.1 до 10 люкс
Напряжение питания - 85-280В 50-60Гц
Максимальная мощность нагрузки - 8А
Степень защиты корпуса - 42IP 
Угол обзора - до ±60 градусов
Дальность действия - до 5м
Освещенность - от 0,1 до 40 тыс. люкс
Рабочая температура от -20 до +45 °С
Световая индикация вхождения в зону - есть  
Wi-Fi - есть, частота 2.4ГГц
Bluetooth - есть, для точной сенсора пристутсвия
Web-интерфейс - есть 
Интеграция в умный дом - есть
Визуальная отладка и настройка - есть 
Технология радарного датчика - 24ГГц

**Web-интерфейс:**

<img width="704" height="889" alt="image" src="https://github.com/user-attachments/assets/eecb7d5a-3b58-435e-a453-82010922f2d6" />

**Интерфейс управления в HomeAssistant: **
<img width="879" height="940" alt="image" src="https://github.com/user-attachments/assets/a3c59e5a-b07a-4770-999d-e9a07e48d1a0" />

1. Ручное управление нагрузкой
2. Регулировка уровня освещенности, ниже которого устройство включает нагрузку
3. Состояния уровней освещенности, движения и присутствия в зоне обнаружения
4. Включение/выключение блютус для возможности точной настройки датчика присутствия
5. Установку таймаута выключения нагрузки после срабатывания


   
