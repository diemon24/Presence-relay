# Переделываем уличный инфракрасный датчик в умный датчик присутствия
**Уличный датчик присутствия ESPHome с интеграцией в HomeAssistant**

За основу я взял уже имеющийся у меня в доме уличный инфракрасный датчик движения с реле. Основная проблема в том, что данные датчики не имеют высокой чувствительности, в отличие от датчиков присутствия, что в результате приводит к выключению реле (а в моем случае и уличного освещения) когда человек, который находится в зоне действия сенсора, почти не двигается. Можно, конечно, увеличить таймаут выключения, надеясь на то, что за это время произойдет движение, достаточное для сброса встроенного таймера, но зачастую этого не происходит. В том числе это увеличивает время работы освещения когда человек покинул зону действия датчика. Дополнительно - он реагирует на все, что движется: паук, муха, оса, деревья, снег, сильный дождь... Поэтому такие датчики (хоть они и названы "уличными" имея влагозащищенный корпус) больше предназначены для помещений - типа подъезд, кладовая, гараж и т.п. Мелочи, но лично меня все это беспокоит и привело к его переделке.

Вот собственно наш объект внимания - они не дорогие и доступны в продаже по сей день. Я даже докупил их для использования корпуса - ведь корпус стоимостью в 400-500 руб. это вполне не дорого для будущего умного устройства. Лично я столкнулся с двумя не критичными отличиями в контруктиве данного корпуса - это способ монтажа платы внутри.
![IMG_20250815_164419](https://github.com/user-attachments/assets/105c47b4-7b45-45b5-abdf-66e55e856d89)

Я поставил перед собой задачу иметь возможность использовать данный датчик не только в качестве умного самостоятельного устройства (в частности управляемого), но и как самостоятельное устройства без возможности управления. Поэтому я спроектировал плату соответствующим образом. 

<img width="1065" height="636" alt="image" src="https://github.com/user-attachments/assets/ca943847-7384-467d-9628-ff085f6bf26e" />

В качестве контроллера взята за основу плата ESP32c3 Suрer Mini, в качестве сенсора присутствия могут использоваться два не дорогих, но вполне себе не плохих, варианта датчиков присутствия - HLK LD2410B ("B" с блютус) и HLK LD2402 или 2420. Об их настройке есть много информации в сети Интернет. Но основной параметр - это их чувствительность, которая ограничивается расстоянием обнаружения присутствия - она составляет (как заявлено производителем, так и фактически проверено мною) - до 7 метров. Для мох задач (освещение небольшой поляны у дома) вполне хватает. А для того, чтобы освещение включать только в ночное время я использовал датчик освещенности GY-2561/TSL2561. Оба эти датчика поддерживаются платформой ESPHome. 

Проект платы: 

<img width="958" height="857" alt="image" src="https://github.com/user-attachments/assets/cd44ddcc-0bf9-4474-8d49-15945121a6f3" />

<img width="931" height="790" alt="image" src="https://github.com/user-attachments/assets/63ca2cf7-0bdd-404b-a48e-2f7f985961f3" />

В случае если необходимо использовать устройство только на включение/выключение нагрузки без контроля уровня освещенности и управления - можно не устанавливать контроллер ESP32 c3 Super Mini и датчик освещенности GY-2561/TSL2561. Для этого мы будем использовать выход состояния присутствия OT2, предусмотренный производителем датчика HLK-LD2410B или HLK-LD2402/HLK-LD2420. 

В случае использования датчика HLK-LD2402/HLK-LD2420 необходимо будет обеспечить его необходимым питанием +3.3В, т.к. на его плате отсутствует стабилизатор напряжения, для чего необходимо будет припаять стаблизатор напряжения DC1 HT7333-3.3 с обвязкой из конденсаторов, который располагается на плате под самим датчиком, когда как HLK-LD2410B можно питать от +5В. 

<img width="470" height="243" alt="image" src="https://github.com/user-attachments/assets/b7b12d2e-7781-45eb-a1b7-2ea09469d75f" />

Сразу обращу внимание, что с датчиком HLK-LD2420 у меня не задалось с самого начала. То ли ESPHome их не поддерживает корректно, то ли в моей партии закупки они глючные, но мне не удалось их использовать корректно в связке с ESPHome. Хотя некоторые коллеги по сообществу EPSHome говорили, что у них с этими датчиками проблем нет. Но его точно можно использовать в качестве самостоятельного устройства после отладки. 

![IMG_20250815_085629](https://github.com/user-attachments/assets/c5c3e036-1402-4a86-9289-b512d3a21116)

Для изменения режимов работы датчика (умный/не умный :) ) на плате предусмотрена перемчка "ESP/OI2". ОТ2 - это контакт состояния присутствия на датчиках присутствия, т.е. управляющий контакт с датчика напрямую подключается к цепи управления реле. Реле, кстати, использовано на нагрузку 8А, что вполне достаточно для управления группой освещения. 

В конечном счете у меня получилось вот такое устройство: 

![IMG_20250815_162640](https://github.com/user-attachments/assets/039347ea-71d7-480d-af6a-d708b3060c7f)

![IMG_20250815_162457](https://github.com/user-attachments/assets/dc328252-fe3b-4e52-a684-9a7f6c7c2a61)

![IMG_20250815_162516](https://github.com/user-attachments/assets/625ff2f6-3654-4613-8e10-9cf06d118621)

С демонтированным окошком:
![IMG_20250816_225300](https://github.com/user-attachments/assets/458e3591-c7f2-4a12-a03a-1b56ae5fd67a)

Статусный светодиод можно отладить как угодно - подключается на отдельный GPIO, я использую его на мигание сразу после обнаружения движения с последующим включением освещения. Но надо иметь ввиду, что в случае использования датчика освещенности данный светодиод создает дополнительное освещение, что "сбивает с толку" датчик освещенности. 

По результатам испытаний немного доработал способ монтажа датчика, т.к. угол его обзора приводит к отражению высокочастотного сигнала о толстые стенки корпуса, поэтому датчик вынес вперед. Но, как говорится, инструкции от производителя мы читаем после возникновения проблем, но в целом не вижу критичности, т.к. в конечном счете все работает как нужно и без танцев с бубном. Для этого использовано 4 разъема с шагом 1.27 на 5 пинов.  

![IMG_20250827_105243](https://github.com/user-attachments/assets/064089f7-7948-4399-818a-888faa1786d5)

Gerber и BOM файл:
[Gerber_PCB1_2025-09-09.zip](https://github.com/user-attachments/files/22231243/Gerber_PCB1_2025-09-09.zip)
[BOM_Board1_PCB1_2025-09-09.xlsx](https://github.com/user-attachments/files/22231246/BOM_Board1_PCB1_2025-09-09.xlsx)

Импульсный источник питания Interest Maker AC-DC https://sl.aliexpress.ru/p?key=KmZYVdM
Реле мощности Your Cee HF32FA-G https://sl.aliexpress.ru/p?key=6uZYVOv
Однорядный гнездовой штифт 1,27 мм https://sl.aliexpress.ru/p?key=zdZYVUA.

Прошивка: [presence-sensor-street-1.yaml](https://github.com/user-attachments/files/22231539/presence-sensor-street-1.yaml)

В итоге мы получили в HomeAssistant: 
<img width="879" height="940" alt="image" src="https://github.com/user-attachments/assets/a3c59e5a-b07a-4770-999d-e9a07e48d1a0" />

1. Ручное управление нагрузкой
2. Регулировка уровня освещенности, ниже которого устройство включает нагрузку
3. Состояния уровней освещенности, движения и присутствия в зоне обнаружения
4. Включение/выключение блютус для возможности точной настройки датчика присутствия
5. Установку таймаута выключения нагрузки после срабатывания

   
